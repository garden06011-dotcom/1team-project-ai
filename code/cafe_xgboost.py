import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.metrics import mean_absolute_error, r2_score
from xgboost import XGBRegressor
import joblib

# ---------------------------------------------------------
# 1. 엑셀 불러오기
# ---------------------------------------------------------
df = pd.read_excel("y추가완료_카페 데이터칼럼.xlsx")   # 파일명 변경!

# ---------------------------------------------------------
# 2. X / Y 변수 설정
# ---------------------------------------------------------
X_cols = [
    "정규화매출효율",
    "정규화성장률",
    "정규화경쟁점수",
    "작년 매출",
    "이전 매출",
    "작년 점포수",
    "이전 점포수"
]

y_col = "Y점수 정규화"

X = df[X_cols]
y = df[y_col]

# ---------------------------------------------------------
# 3. train/test 분할
# ---------------------------------------------------------
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42
)

# ---------------------------------------------------------
# 4. XGBoost 모델 생성/학습
# ---------------------------------------------------------
model = XGBRegressor(
    n_estimators=400,
    learning_rate=0.05,
    max_depth=6,
    subsample=0.8,
    colsample_bytree=0.8,
    random_state=42
)

model.fit(X_train, y_train)

# ---------------------------------------------------------
# 5. 테스트 성능 출력
# ---------------------------------------------------------
y_pred = model.predict(X_test)
print("=== XGBoost 모델 성능 ===")
print(f"MAE : {mean_absolute_error(y_test, y_pred):.4f}")
print(f"R²  : {r2_score(y_test, y_pred):.4f}")

# ---------------------------------------------------------
# 6. 전체 행 예측값 추가
# ---------------------------------------------------------
df["예측Y"] = model.predict(X)

# ---------------------------------------------------------
# 7. 동별 대표 점수 = "평균점수"만 계산
# ---------------------------------------------------------
dong_scores = df.groupby("행정동명")["예측Y"].mean().rename("동별_평균점수")

# ---------------------------------------------------------
# 8. 엑셀로 저장
# ---------------------------------------------------------
dong_scores.to_excel("cafe_XGBoost.xlsx")
print("\n파일 저장 완료: cafe_XGBoost.xlsx")

# ---------------------------------------------------------
# 9. 특정 동 점수 출력 (예: 청운효자동)
# ---------------------------------------------------------
dong_name = "청운효자동"

if dong_name in dong_scores.index:
    print(f"\n[{dong_name}] 평균 점수 :", dong_scores.loc[dong_name])
else:
    print("\n해당 동이 존재하지 않습니다.")

# ---------------------------------------------------------
# 10. 모델 저장 (.pkl)
# ---------------------------------------------------------
joblib.dump(model, "cafe_XGBoost.pkl")
print("\nXGBoost 모델 저장 완료: cafe_XGBoost.pkl")
